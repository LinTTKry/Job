# 导航流程：从输入URL到页面展示，这中间发生了什么？

## <mark style="color:red;">​\*从输入 URL 到页面展示完整流程示意图</mark>

![](<../.gitbook/assets/image (80) (1) (1) (1).png>)

* 浏览器进程主要负责<mark style="color:blue;">**用户交互、子进程管理和文件储存**</mark>等功能。
* 网络进程是面向渲染进程和浏览器进程等提供<mark style="color:blue;">**网络下载**</mark>功能。
* 渲染进程的主要职责是把从网络下载的 HTML、JavaScript、CSS、图片等<mark style="color:blue;">**资源解析为可以显示和交互的页面**</mark>。因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。这也是为什么 Chrome 会让渲染进程运行在安全沙箱里，就是为了保证系统的安全。

大致流程：

* 首先，浏览器进程接收到用户输入的 URL 请求，浏览器进程便将该 URL 转发给网络进程。
* 然后，在网络进程中发起真正的 URL 请求。
* 接着网络进程接收到了响应头数据，便解析响应头数据，并将数据转发给浏览器进程。
* 浏览器进程接收到网络进程的响应头数据之后，发送“提交导航 (CommitNavigation)”消息到渲染进程；
* 渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道；
* 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接受和解析页面数据了”。
* 浏览器进程接收到渲染进程“提交文档”的消息之后，便开始移除之前旧的文档，然后更新浏览器进程中的页面状态。

这其中，<mark style="color:blue;">**用户发出 URL 请求到页面开始解析的这个过程，就叫做导航**</mark>。

## 从输入URL到页面展示

### 1. 用户输入

当用户输入关键字并键入回车之后，这意味着<mark style="color:blue;">**当前页面即将要被替换成新的页面，不过在这个流程继续之前，浏览器还给了当前页面一次执行 beforeunload 事件的机会，beforeunload 事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面**</mark>，比如当前页面可能有未提交完成的表单等情况，因此用户可以通过 beforeunload 事件来取消导航，让浏览器不再执行任何后续工作。

当前页面没有监听 beforeunload 事件或者同意了继续后续流程，那么浏览器便进入下面的状态：

刚<mark style="color:blue;">**开始加载一个地址之后，标签页上的图标便进入了加载状态。但此时图中页面显示的依然是之前打开的页面内容，并没立即替换为极客时间的页面。因为需要等待提交文档阶段**</mark>，页面内容才会被替换。

### 2. URL请求过程(HTTP请求流程)

### 3. 准备渲染进程

**“**<mark style="color:blue;">**同一站点**</mark><mark style="color:blue;">”</mark>定义为<mark style="color:blue;">**根域名（例如，geekbang.org）加上协议**</mark><mark style="color:blue;">（</mark>例如，https:// 或者 http://），还包含了该根域名下的<mark style="color:blue;">**所有子域名和不同的端口**</mark>，比如下面这三个：

```javascript
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```

Chrome 的默认策略是，<mark style="color:blue;">**每个标签对应一个渲染进程。但如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程。**</mark>

### 4. 提交文档

所谓提交文档，就是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程，具体流程是这样的：

* 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；
* 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
* 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
* 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

其中，当渲染进程确认提交之后，更新内容如下图所示：

![](<../.gitbook/assets/image (77) (1) (1).png>)

这也就解释了为什么在浏览器的地址栏里面输入了一个地址后，之前的页面没有立马消失，而是要加载一会儿才会更新页面。

### 5. 渲染阶段

一旦文档被提交，渲染进程便开始页面解析和子资源加载了。

