# TCP协议：如何保证页面文件能被完整送达浏览器？

​在衡量 Web 页面性能的时候有一个重要的指标叫“<mark style="color:blue;">**FP（First Paint）**</mark>”，是指从<mark style="color:blue;">**页面加载到首次开始绘制的时长；**</mark>

## 一个数据包的“旅程”

### 1. IP: 把数据包送达目的主机

数据包要在互联网上进行传输，就要符合网际协议（Internet Protocol，简称 IP）标准。

![](<../.gitbook/assets/image (57).png>)

* 上层将含有“极客时间”的数据包交给网络层；
* 网络层再将 <mark style="color:blue;">**IP 头（主机A与主机B的IP地址）附**</mark>加到数据包上，组成新的 IP 数据包，并交给底层；
* 底层通过物理网络将数据包传输给主机 B；
* 数据包被传输到主机 B 的网络层，在这里主机 B 拆开数据包的 IP 头信息，并将拆开来的数据部分交给上层；
* 最终，含有“极客时间”信息的数据包就到达了主机 B 的上层了

### 2. UDP：把数据包送达应用程序

IP 是非常底层的协议，只负责把数据包传送到对方电脑，但是对方电脑并不知道把**数据包交给哪个程序**，是交给浏览器还是交给王者荣耀？因此，需要基于 IP 之上开发能和应用打交道的协议，最常见的是**“用户数据包协议（User Datagram Protocol）”，简称 UDP**。

UDP 中一个最重要的信息是**端口号**，端口号其实就是一个**数字**，**每个想访问网络的程序都需要绑定一个端口号**。通过端口号 UDP 就能把指定的数据包发送给指定的程序了，所以 <mark style="color:blue;">**IP 通过 IP 地址信息把数据包发送给指定的电脑，而 UDP 通过端口号把数据包分发给正确的程序。**</mark>

![](<../.gitbook/assets/image (65).png>)

* 上层将含有“极客时间”的数据包交给传输层；
* 传输层会在数据包前面附加上 UDP 头，组成新的 UDP 数据包，再将新的 UDP 数据包交给网络层；
* 网络层再将 IP 头附加到数据包上，组成新的 IP 数据包，并交给底层；
* 数据包被传输到主机 B 的网络层，在这里主机 B 拆开 IP 头信息，并将拆开来的数据部分交给传输层
* 在传输层，数据包中的 UDP 头会被拆开，并根据 UDP 中所提供的端口号，把数据部分交给上层的应用程序；
* 最终，含有“极客时间”信息的数据包就旅行到了主机 B 上层应用程序这里。

虽说 <mark style="color:blue;">**UDP 不能保证数据可靠性，但是传输速度却非常快**</mark>，所以 UDP 会应用在一些关注速度、但不那么严格要求数据完整性的领域，如在线视频、互动游戏等

使用 UDP 来传输会存在两个问题：

* 数据包在传输过程中容易丢失；（<mark style="color:blue;">**丢包**</mark>）
* 大文件会被拆分成很多小的数据包来传输，这些小的数据包会经过不同的路由，并在不同的时间到达接收端，而 UDP 协议并不知道如何组装这些数据包，从而把这些数据包还原成完整的文件。（<mark style="color:blue;">**乱序**</mark>）

### <mark style="color:red;">3.</mark> <mark style="color:red;"></mark><mark style="color:red;"><mark style="color:blue;">****<mark style="color:blue;"></mark> <mark style="color:red;"></mark><mark style="color:red;">TCP：把数据完整地送达应用程序</mark>

TCP（Transmission Control Protocol，传输控制协议）是一种<mark style="color:blue;">**面向连接的、可靠的、基于字节流**</mark>的传输层通信协议。

* 对于数据包丢失的情况，TCP 提供<mark style="color:blue;">**重传**</mark>机制；
* TCP 引入了<mark style="color:blue;">**数据包排序机制**</mark>，用来保证把乱序的数据包组合成一个完整的文件

和 UDP 头一样，<mark style="color:blue;">**TCP 头除了包含了目标端口和本机端口号外，还提供了用于排序的序列号，以便接收端通过序号来重排数据包。**</mark>

![](<../.gitbook/assets/image (81).png>)

完整的 TCP 连接过程

![](<../.gitbook/assets/image (83).png>)

* 首先，建立连接阶段。这个阶段是通过“三次握手”来建立客户端和服务器之间的连接。TCP 提供面向连接的通信传输。面向连接是指在数据通信开始之前先做好两端之间的准备工作。所谓三次握手，是指在建立一个 TCP 连接时，客户端和服务器总共要发送三个数据包以确认连接的建立。
* 其次，传输数据阶段。在该阶段，接收端需要对每个数据包进行确认操作，也就是<mark style="color:blue;">**接收端在接收到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制**</mark>。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据。
* 最后，断开连接阶段。数据传输完毕之后，就要终止连接了，涉及到最后一个阶段“四次挥手”来保证双方都能断开连接。

TCP 为了保证数据传输的可靠性，<mark style="color:blue;">**牺牲了数据包的传输速度，因为“三次握手”和“数据包校验机制”等把传输过程中的数据包的数量提高了一倍**</mark>**。**

### 相关知识点

* <mark style="color:blue;">**HTTP协议属于应用层，TCP协议属于传输层，HTTP协议位于TCP协议的上层**</mark>：请求方要发送的数据包，在应用层加上HTTP头以后会交给传输层的TCP协议处理，应答方接收到的数据包，在传输层拆掉TCP头以后交给应用层的HTTP协议处理。建立 TCP 连接后会顺序收发数据，请求方和应答方都必须依据 HTTP 规范构建和解析HTTP报文。
* TCP传送数据时 浏览器端就做渲染处理了么？如果前面数据包丢了 后面数据包先来是要等么？类似的那种实时渲染怎么处理？针对数据包的顺序性？

&#x20;接收到<mark style="color:blue;">**http响应头中的content-type类型时就开始准备渲染进程了**</mark>，响应体数据一旦接受到便开始做DOM解析了！<mark style="color:blue;">**基于http不用担心数据包丢失的问题，因为丢包和重传都是在tcp层解决的。http能保证数据按照顺序接收的**</mark>（也就是说，从<mark style="color:blue;">**tcp到http的数据就已经是完整的了，即便是实时渲染，如果发生丢包也得在重传后才能开始渲染**</mark>）

*

